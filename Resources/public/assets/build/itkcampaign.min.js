/**
 * @name ItkCampaignBundle
 * @version v1.0.0
 * @link https://github.com/itk-os2display/campaign-bundle
 */
angular.module("itkCampaignApp").config(["$routeProvider","$translateProvider",function(e,n){"use strict";var a="bundles/itkcampaign/apps/itkCampaignApp/";n.useSanitizeValueStrategy("escape").useStaticFilesLoader({prefix:a+"translations/locale-",suffix:".json"}).preferredLanguage("da").fallbackLanguage("da").forceAsyncReload(!0),e.when("/campaign",{controller:"ItkCampaignOverviewController",templateUrl:a+"campaign-overview/campaign-overview.html?"+window.config.version}).when("/campaign/create",{controller:"ItkCampaignController",templateUrl:a+"campaign/campaign.html?"+window.config.version}).when("/campaign/:id",{controller:"ItkCampaignController",templateUrl:a+"campaign/campaign.html?"+window.config.version})}]),angular.module("itkCampaignApp").service("itkCampaignAppSetup",["busService","userService","$translate",function(e,n,a){"use strict";e.$on("menuApp.requestMainMenuItems",function(t,i){n.hasRole("ROLE_ADMIN")&&e.$emit("menuApp.returnMainMenuItems",[{title:a.instant("menu.campaign"),route:"/#/campaign",activeFilter:"/campaign",icon:"picture_in_picture",weight:6}])}),e.$on("menuApp.requestSubMenuItems",function(t,i){var r=[];n.hasRole("ROLE_ADMIN")&&r.push({title:a.instant("menu.campaign_create"),path:"#/campaign/create",activeFilter:"/campaign/create",group:"left",weight:1}),e.$emit("menuApp.returnSubMenuItems",[{mainMenuItem:"campaign",items:r}])})}]),angular.module("itkCampaignApp").run(["itkCampaignAppSetup",angular.noop]),angular.module("itkCampaignApp").directive("contenteditable",function(){return{restrict:"A",require:"ngModel",link:function(e,n,a,t){function i(){t.$setViewValue(n.html())}t.$render=function(){n.html(t.$viewValue||"")},n.bind("blur keyup change",function(){e.$apply(i)})}}}),angular.module("itkCampaignApp").controller("ItkCampaignOverviewController",["busService","$scope","$timeout","ModalService","$routeParams","$location","$controller","$filter","userService",function(e,n,a,t,i,r,c,o,s){"use strict";n.loading=!0,c("BaseApiController",{$scope:n});var l=o("translate");if(!n.requireRole("ROLE_ADMIN"))return e.$emit("log.error",{timeout:5e3,cause:403,msg:l("common.error.forbidden")}),void r.path("/");n.search={title:""},n.getEntities("campaign").then(function(e){n.campaigns=e;var a=parseInt(new Date/1e3);for(var t in n.campaigns)if(n.campaigns.hasOwnProperty(t)){var i=n.campaigns[t],r=parseInt(new Date(i.schedule_from)/1e3),c=parseInt(new Date(i.schedule_to)/1e3);i.status=r<=a&&c>a?"active":c<a?"expired":"future"}},function(n){e.$emit("log.error",{cause:n.code,msg:l("common.error.could_not_load_results")})}).then(function(){n.loading=!1}),n.help=function(){},n.deleteCampaigns=function(){},n.flipSortOrder=function(){},n.clickAllCheckbox=function(){}}]),angular.module("itkCampaignApp").controller("ItkCampaignController",["busService","$scope","$timeout","ModalService","$routeParams","$location","$controller","$filter","userService",function(e,n,a,t,i,r,c,o,s){"use strict";n.loading=!0,c("BaseApiController",{$scope:n});var l=o("translate");if(!n.requireRole("ROLE_ADMIN"))return e.$emit("log.error",{timeout:5e3,cause:403,msg:l("common.error.forbidden")}),void r.path("/");var u=i.id;if(n.campaign=null,u)n.getEntity("campaign",{id:u}).then(function(e){var a;n.campaign=((a=e).schedule_from=parseInt(new Date(a.schedule_from)/1e3),a.schedule_to=parseInt(new Date(a.schedule_to)/1e3),a)},function(n){r.path("/#/campaign"),e.$emit("log.error",{cause:n.code,msg:l("messages.campaign_load_error")})}).then(function(){n.loading=!1});else{var p=new Date;p.setMilliseconds(0),p.setSeconds(0),p.setMinutes(0),p=parseInt(p/1e3),n.campaign={title:"",description:"",schedule_from:p,schedule_to:p+86400,channels:[],screens:[],screen_groups:[],groups:[]},n.loading=!1}n.addChannels=function(){n.campaign.channels||(n.campaign.channels=[]),e.$emit("bodyService.addClass","is-locked"),t.showModal({templateUrl:"bundles/itkcampaign/apps/itkCampaignApp/campaign/itkCampaignModalAddChannel.html",controller:"ItkCampaignModalAddChannel",inputs:{channels:n.campaign.channels}}).then(function(n){n.close.then(function(){e.$emit("bodyService.removeClass","is-locked")})})},n.removeChannel=function(e){-1!==n.campaign.channels.indexOf(e)&&n.campaign.channels.splice(e,1)},n.addScreens=function(){n.campaign.screens||(n.campaign.screens=[]),e.$emit("bodyService.addClass","is-locked"),t.showModal({templateUrl:"bundles/itkcampaign/apps/itkCampaignApp/campaign/itkCampaignModalAddScreen.html",controller:"ItkCampaignModalAddScreen",inputs:{screens:n.campaign.screens}}).then(function(n){n.close.then(function(){e.$emit("bodyService.removeClass","is-locked")})})},n.removeScreen=function(e){-1!==n.campaign.screens.indexOf(e)&&n.campaign.screens.splice(e,1)},n.addScreenGroups=function(){n.campaign.screen_groups||(n.campaign.screen_groups=[]),e.$emit("bodyService.addClass","is-locked"),t.showModal({templateUrl:"bundles/itkcampaign/apps/itkCampaignApp/campaign/itkCampaignModalAddScreenGroup.html",controller:"ItkCampaignModalAddScreenGroup",inputs:{screenGroups:n.campaign.screen_groups}}).then(function(n){n.close.then(function(){e.$emit("bodyService.removeClass","is-locked")})})},n.removeScreenGroup=function(e){-1!==n.campaign.screen_groups.indexOf(e)&&n.campaign.screen_groups.splice(e,1)},n.save=function(){var a,t=angular.copy(n.campaign);(a=t).schedule_from=new Date(1e3*a.schedule_from).toUTCString(),a.schedule_to=new Date(1e3*a.schedule_to).toUTCString(),t=a,n.loading=!0,void 0===n.campaign.id?n.createEntity("campaign",t).then(function(){e.$emit("log.info",{cause:200,timeout:3e3,msg:l("messages.campaign_created")})},function(n){e.$emit("log.error",{cause:n.code,msg:l("messages.campaign_created_error")})}).then(function(){n.loading=!1}):n.updateEntity("campaign",t).then(function(){e.$emit("log.info",{cause:200,timeout:3e3,msg:l("messages.campaign_updated")})},function(n){e.$emit("log.error",{cause:n.code,msg:l("messages.campaign_updated_error")})}).then(function(){n.loading=!1})}}]),angular.module("itkCampaignApp").controller("ItkCampaignModalAddChannel",["busService","$scope","$timeout","close","channels",function(e,n,a,t,i){"use strict";n.channels=i,n.$on("channelOverview.clickChannel",function(e,t){var i;i=t,a(function(){var e=null;n.channels.forEach(function(n,a){i.id===n.id&&(e=a)}),null!==e?n.channels.splice(e,1):n.channels.push(i)})}),n.closeModal=function(){t(null)}}]),angular.module("itkCampaignApp").controller("ItkCampaignModalAddScreen",["busService","$scope","$timeout","close","screens",function(e,n,a,t,i){"use strict";n.screens=i,n.$on("itkScreenList.clickScreen",function(e,t){var i;i=t,a(function(){var e=null;n.screens.forEach(function(n,a){i.id===n.id&&(e=a)}),null!==e?n.screens.splice(e,1):n.screens.push(i)})}),n.closeModal=function(){t(null)}}]),angular.module("itkCampaignApp").controller("ItkCampaignModalAddScreenGroup",["busService","$scope","$timeout","close","screenGroups","userService",function(e,n,a,t,i,r){"use strict";n.availableGroups=r.getCurrentUser().groups,n.screenGroups=i,n.groupSelected=function(e){if(!n.screenGroups)return!1;var a=!1;return n.screenGroups.forEach(function(n){n.id===e.id&&(a=!0)}),a},n.clickGroup=function(e){var t;t=e,a(function(){var e=null;n.screenGroups.forEach(function(n,a){t.id===n.id&&(e=a)}),null!==e?n.screenGroups.splice(e,1):n.screenGroups.push(t)})},n.closeModal=function(){t(null)}}]),angular.module("itkCampaignApp").directive("itkScreenList",["busService","$translate",function(e,n){"use strict";return{restrict:"E",scope:{selectedScreens:"=",overlay:"@"},controller:["$scope","$filter","$controller","screenFactory","userService","busService",function(e,a,t,i,r,c){t("BaseSearchController",{$scope:e}),e.showFromUser=localStorage.getItem("overview.media.search_filter_default")?localStorage.getItem("overview.media.search_filter_default"):"all",e.screens=[];var o=null;e.updateSearch=function(){e.baseQuery.text=e.search_text,e.loading=!0,i.searchScreens(e.baseQuery).then(function(a){e.hits=a.hits;for(var t=[],r=0;r<a.results.length;r++)t.push(a.results[r].id);o&&t.length===o.length&&t.every(function(e,n){return e===o[n]})?e.loading=!1:(o=t,i.loadScreensBulk(t).then(function(n){e.screens=n,e.loading=!1},function(a){c.$emit("log.error",{cause:a,msg:n("common.error.could_not_load_results")}),e.loading=!1}))})},e.screenSelected=function(n){if(!e.selectedScreens)return!1;var a=!1;return e.selectedScreens.forEach(function(e){e.id===n.id&&(a=!0)}),a},e.clickScreen=function(n){e.$emit("itkScreenList.clickScreen",n)},e.$on("screen-deleted",function(){e.updateSearch()}),e.setSearchFilters=function(){delete e.baseQuery.filter;var n=a("filter")(e.userGroups,{selected:!0},!0).map(function(e){return e.id});e.baseQuery.filter=e.baseBuildSearchFilter(n),e.pager.page=0,e.updateSearch()},e.setSearchFilters()}],templateUrl:"bundles/itkcampaign/apps/itkCampaignApp/directives/screenList/itkScreenList.html?"+window.config.version}}]);