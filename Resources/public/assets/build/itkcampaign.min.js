/**
 * @name CampaignBundle
 * @version v1.0.0
 * @link https://github.com/os2display/campaign-bundle
 */
angular.module("campaignApp").config(["$routeProvider","$translateProvider",function(e,n){"use strict";var a="bundles/os2displaycampaign/apps/campaignApp/";n.useSanitizeValueStrategy("escape").useStaticFilesLoader({prefix:a+"translations/locale-",suffix:".json"}).preferredLanguage("da").fallbackLanguage("da").forceAsyncReload(!0),e.when("/campaign",{controller:"CampaignOverviewController",templateUrl:a+"campaign-overview/campaign-overview.html?"+window.config.version}).when("/campaign/create",{controller:"CampaignController",templateUrl:a+"campaign/campaign.html?"+window.config.version}).when("/campaign/:id",{controller:"CampaignController",templateUrl:a+"campaign/campaign.html?"+window.config.version})}]),angular.module("campaignApp").service("campaignAppSetup",["busService","userService","$translate","$filter",function(t,i,r,c){"use strict";t.$on("menuApp.requestMainMenuItems",function(e,n){i.hasRole("ROLE_CAMPAIGN_ADMIN")&&t.$emit("menuApp.returnMainMenuItems",[{title:r.instant("menu.campaign"),route:"/#/campaign",activeFilter:"/campaign",icon:"picture_in_picture",weight:6}])}),t.$on("menuApp.requestHamburgerMenuItems",function(e,n){t.$emit("menuApp.returnHamburgerMenuItems",[{title:r.instant("menu.campaign"),weight:5,items:[{title:"Oversigt",route:"/#/campaign",activeFilter:"/campaign",weight:1},{title:"Opret kanal",route:"/#/campaign/create",activeFilter:"/campaign/create",weight:2}]}])}),t.$on("menuApp.requestSubMenuItems",function(e,n){var a=[];i.hasRole("ROLE_CAMPAIGN_ADMIN")&&a.push({title:r.instant("menu.campaign_create"),path:"#/campaign/create",activeFilter:"/campaign/create",group:"left",weight:1}),t.$emit("menuApp.returnSubMenuItems",[{mainMenuItem:"campaign",items:a}])}),t.$on("itkHeader.list.element.requestItems",function(e,n){if("screen"===n.type){var a=n.entity.api_data;if(a&&a.active_campaigns&&0<a.active_campaigns.length){var i='<div class="os2display-campaign-info">  <div tooltips tooltip-template="'+("<p>"+r.instant("messages.active_campaign_exists")+"</p>")+'" tooltip-side="top">    <img class="os2display-campaign-info--icon" src="bundles/os2displayadmin/images/icons/exclamation-icon.png" title="">  </div></div>';t.$emit(n.returnEvent,{html:i,type:"warning"})}}}),t.$on("itkHeader.entity.requestItems",function(e,n){if("screen"===n.type){var a=n.entity.api_data;if(a&&a.active_campaigns&&0<a.active_campaigns.length){var i='<div class="message os2display-campaign-info--message">  <div class="message--inner is-info">    <div class="message--content">'+a.active_campaigns.reduce(function(e,n){return e+"<p>"+r.instant("messages.active_campaign")+c("date")(n.schedule_from,"d/M/yyyy H:mm")+" - "+c("date")(n.schedule_to,"d/M/yyyy H:mm")+' (<a href="/#/campaign/'+n.id+'">'+n.title+"</a>)</p>"},"")+"    </div>  </div></div>";t.$emit(n.returnEvent,{html:i,type:"warning"})}}})}]),angular.module("campaignApp").run(["campaignAppSetup",angular.noop]),angular.module("campaignApp").controller("CampaignModalBase",["busService","$scope","$timeout","close",function(e,n,a,i){"use strict";n.closeModal=function(){i(null)}}]),angular.module("campaignApp").directive("contenteditable",function(){return{restrict:"A",require:"ngModel",link:function(e,n,a,i){function t(){i.$setViewValue(n.html())}i.$render=function(){n.html(i.$viewValue||"")},n.bind("blur keyup change",function(){e.$apply(t)})}}}),angular.module("campaignApp").controller("CampaignOverviewController",["busService","$scope","$timeout","ModalService","$routeParams","$location","$controller","$filter","$q",function(i,c,e,n,a,t,r,o,s){"use strict";c.loading=!0,c.selectedCampaigns={},c.sortOrder=!0,c.search={title:""},c.allCheckbox=!1,r("BaseApiController",{$scope:c});var l=o("translate");if(!c.requireRole("ROLE_CAMPAIGN_ADMIN"))return i.$emit("log.error",{timeout:5e3,cause:403,msg:l("common.error.forbidden")}),void t.path("/");function u(){c.loading=!0,c.getEntities("campaign").then(function(n){c.campaigns=Object.keys(n).map(function(e){return n[e]});var e=parseInt(new Date/1e3);for(var a in c.campaigns)if(c.campaigns.hasOwnProperty(a)){var i=c.campaigns[a],t=parseInt(new Date(i.schedule_from)/1e3),r=parseInt(new Date(i.schedule_to)/1e3);i.status=t<=e&&e<r?"active":r<e?"expired":"future"}},function(e){i.$emit("log.error",{cause:e.code,msg:l("common.error.could_not_load_results")})}).then(function(){c.loading=!1})}u(),c.help=function(){i.$emit("bodyService.addClass","is-locked"),n.showModal({templateUrl:"bundles/os2displaycampaign/apps/campaignApp/campaign-overview/modalHelp.html",controller:"CampaignModalBase"}).then(function(e){e.close.then(function(){i.$emit("bodyService.removeClass","is-locked")})})},c.deleteCampaigns=function(){if(c.showDelete()){var t=[],e=angular.element(".js-campaign-checkbox");angular.forEach(e,function(e){var n=e.id,a=e.checked;if(-1!==n.indexOf("campaign-")&&(n=parseInt(n.split("campaign-")[1]),a)){var i=c.campaigns.find(function(e){return e.id===n});i&&t.push(i)}}),n.showModal({templateUrl:"bundles/os2displaycampaign/apps/campaignApp/campaign-overview/campaignOverviewModalDelete.html",controller:"CampaignOverviewModalDelete",inputs:{campaigns:t}}).then(function(e){e.close.then(function(e){if(!0===e){var n=[];for(var a in t)t.hasOwnProperty(a)&&n.push(c.deleteEntity("campaign",t[a]));s.all(n).then(function(){u(),i.$emit("log.info",{cause:200,timeout:3e3,msg:l("messages.campaign_delete_success")})},function(e){i.$emit("log.error",{cause:e.code,msg:l("messages.campaign_delete_error")})})}i.$emit("bodyService.removeClass","is-locked")})})}},c.flipSortOrder=function(){c.sortOrder=!c.sortOrder},c.showDelete=function(){return Object.values(c.selectedCampaigns).reduce(function(e,n){return e+(n?1:0)},0)},c.clickAllCheckbox=function(e){var n=angular.element(".js-campaign-checkbox"),t=[];angular.forEach(n,function(e){var n=e.id,a=e.checked;if(-1!==n.indexOf("campaign-")&&(n=parseInt(n.split("campaign-")[1]),a)){var i=c.campaigns.find(function(e){return e.id===n});i&&t.push(i)}}),t.length===c.campaigns.length?(angular.forEach(n,function(e){e.checked=!1}),c.selectedCampaigns=c.campaigns.reduce(function(e,n){return e[n.id]=!1,e},{}),c.allCheckbox=!1):(angular.forEach(n,function(e){e.checked=!0}),c.selectedCampaigns=c.campaigns.reduce(function(e,n){return e[n.id]=!0,e},{}),c.allCheckbox=!0)},c.clickCheckbox=function(){c.allCheckbox=Object.values(c.selectedCampaigns).reduce(function(e,n){return e+(n?1:0)},0)===c.campaigns.length}}]),angular.module("campaignApp").controller("CampaignOverviewModalDelete",["busService","$scope","$timeout","close","campaigns",function(e,n,a,i,t){"use strict";n.campaigns=t,n.confirm=function(){i(!0)},n.closeModal=function(){i(null)}}]),angular.module("campaignApp").controller("CampaignController",["busService","$scope","$timeout","ModalService","$routeParams","$location","$controller","$filter",function(a,i,e,n,t,r,c,o){"use strict";i.loading=!0,c("BaseApiController",{$scope:i});var s=o("translate");if(!i.requireRole("ROLE_CAMPAIGN_ADMIN"))return a.$emit("log.error",{timeout:5e3,cause:403,msg:s("common.error.forbidden")}),void r.path("/");var l=t.id;if(i.campaign=null,l)i.getEntity("campaign",{id:l}).then(function(e){var n;i.campaign=((n=e).schedule_from=parseInt(new Date(n.schedule_from)/1e3),n.schedule_to=parseInt(new Date(n.schedule_to)/1e3),n)},function(e){r.path("/#/campaign"),a.$emit("log.error",{cause:e.code,msg:s("messages.campaign_load_error")})}).then(function(){i.loading=!1});else{var u=new Date;u.setMilliseconds(0),u.setSeconds(0),u.setMinutes(0),u=parseInt(u/1e3),i.campaign={title:"",description:"",schedule_from:u,schedule_to:u+86400,channels:[],screens:[],screen_groups:[],groups:[]},i.loading=!1}i.addChannels=function(){i.campaign.channels||(i.campaign.channels=[]),a.$emit("bodyService.addClass","is-locked"),n.showModal({templateUrl:"bundles/os2displaycampaign/apps/campaignApp/campaign/campaignModalAddChannel.html",controller:"CampaignModalAddChannel",inputs:{channels:i.campaign.channels}}).then(function(e){e.close.then(function(){a.$emit("bodyService.removeClass","is-locked")})})},i.removeChannel=function(e){-1!==i.campaign.channels.indexOf(e)&&i.campaign.channels.splice(e,1)},i.addScreens=function(){i.campaign.screens||(i.campaign.screens=[]),a.$emit("bodyService.addClass","is-locked"),n.showModal({templateUrl:"bundles/os2displaycampaign/apps/campaignApp/campaign/campaignModalAddScreen.html",controller:"CampaignModalAddScreen",inputs:{screens:i.campaign.screens}}).then(function(e){e.close.then(function(){a.$emit("bodyService.removeClass","is-locked")})})},i.removeScreen=function(e){-1!==i.campaign.screens.indexOf(e)&&i.campaign.screens.splice(e,1)},i.addScreenGroups=function(){i.campaign.screen_groups||(i.campaign.screen_groups=[]),a.$emit("bodyService.addClass","is-locked"),n.showModal({templateUrl:"bundles/os2displaycampaign/apps/campaignApp/campaign/campaignModalAddScreenGroup.html",controller:"CampaignModalAddScreenGroup",inputs:{screenGroups:i.campaign.screen_groups}}).then(function(e){e.close.then(function(){a.$emit("bodyService.removeClass","is-locked")})})},i.removeScreenGroup=function(e){-1!==i.campaign.screen_groups.indexOf(e)&&i.campaign.screen_groups.splice(e,1)},i.save=function(){if(i.campaign.title){i.loading=!0;var e,n=angular.copy(i.campaign);(e=n).schedule_from=new Date(1e3*e.schedule_from).toISOString(),e.schedule_to=new Date(1e3*e.schedule_to).toISOString(),n=e,void 0===i.campaign.id?i.createEntity("campaign",n).then(function(){a.$emit("log.info",{cause:200,timeout:3e3,msg:s("messages.campaign_created")}),r.path("/campaign")},function(e){var n=s("messages.campaign_created_error");409===e.code&&(n=s("messages.campaign_created_error_duplicate")),a.$emit("log.error",{cause:e.code,msg:n})}).then(function(){i.loading=!1,window.scrollTo(0,0)}):i.updateEntity("campaign",n).then(function(){a.$emit("log.info",{cause:200,timeout:3e3,msg:s("messages.campaign_updated")}),r.path("/campaign")},function(e){var n=s("messages.campaign_updated_error");409===e.code&&(n=s("messages.campaign_updated_error_duplicate")),a.$emit("log.error",{cause:e.code,msg:n})}).then(function(){i.loading=!1,window.scrollTo(0,0)})}else a.$emit("log.error",{cause:400,msg:s("messages.campaign_created_error_no_title")})}}]),angular.module("campaignApp").controller("CampaignModalAddChannel",["busService","$scope","$timeout","close","channels",function(e,t,a,n,i){"use strict";t.channels=i,t.$on("channelOverview.clickChannel",function(e,n){var i;i=n,a(function(){var a=null;t.channels.forEach(function(e,n){i.id===e.id&&(a=n)}),null!==a?t.channels.splice(a,1):t.channels.push(i)})}),t.closeModal=function(){n(null)}}]),angular.module("campaignApp").controller("CampaignModalAddScreen",["busService","$scope","$timeout","close","screens",function(e,t,a,n,i){"use strict";t.screens=i,t.$on("itkScreenList.clickScreen",function(e,n){var i;i=n,a(function(){var a=null;t.screens.forEach(function(e,n){i.id===e.id&&(a=n)}),null!==a?t.screens.splice(a,1):t.screens.push(i)})}),t.closeModal=function(){n(null)}}]),angular.module("campaignApp").controller("CampaignModalAddScreenGroup",["busService","$scope","$timeout","close","screenGroups","userService",function(e,t,n,a,i,r){"use strict";t.availableGroups=r.getCurrentUser().groups,t.screenGroups=i,t.groupSelected=function(n){if(!t.screenGroups)return!1;var a=!1;return t.screenGroups.forEach(function(e){e.id===n.id&&(a=!0)}),a},t.clickGroup=function(e){var i;i=e,n(function(){var a=null;t.screenGroups.forEach(function(e,n){i.id===e.id&&(a=n)}),null!==a?t.screenGroups.splice(a,1):t.screenGroups.push(i)})},t.closeModal=function(){a(null)}}]),angular.module("campaignApp").directive("itkScreenList",["busService","$translate",function(e,o){"use strict";return{restrict:"E",scope:{selectedScreens:"=",overlay:"@"},controller:["$scope","$filter","$controller","screenFactory","userService","busService",function(i,n,e,t,a,r){e("BaseSearchController",{$scope:i}),i.showFromUser=localStorage.getItem("overview.media.search_filter_default")?localStorage.getItem("overview.media.search_filter_default"):"all",i.screens=[];var c=null;i.updateSearch=function(){i.baseQuery.text=i.search_text,i.loading=!0,t.searchScreens(i.baseQuery).then(function(e){i.hits=e.hits;for(var n=[],a=0;a<e.results.length;a++)n.push(e.results[a].id);c&&n.length===c.length&&n.every(function(e,n){return e===c[n]})?i.loading=!1:(c=n,t.loadScreensBulk(n).then(function(e){i.screens=e,i.loading=!1},function(e){r.$emit("log.error",{cause:e,msg:o("common.error.could_not_load_results")}),i.loading=!1}))})},i.screenSelected=function(n){if(!i.selectedScreens)return!1;var a=!1;return i.selectedScreens.forEach(function(e){e.id===n.id&&(a=!0)}),a},i.clickScreen=function(e){i.$emit("itkScreenList.clickScreen",e)},i.$on("screen-deleted",function(){i.updateSearch()}),i.setSearchFilters=function(){delete i.baseQuery.filter;var e=n("filter")(i.userGroups,{selected:!0},!0).map(function(e){return e.id});i.baseQuery.filter=i.baseBuildSearchFilter(e),i.pager.page=0,i.updateSearch()},i.setSearchFilters()}],templateUrl:"bundles/os2displaycampaign/apps/campaignApp/directives/screenList/itkScreenList.html?"+window.config.version}}]);
