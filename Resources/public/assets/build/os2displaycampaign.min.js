/**
 * @name Os2DisplayCampaignBundle
 * @version v1.0.0
 * @link https://github.com/os2display/campaign-bundle
 */
angular.module("campaignApp").config(["$routeProvider","$translateProvider",function(e,n){"use strict";var a="bundles/os2displaycampaign/apps/campaignApp/";n.useSanitizeValueStrategy("escape").useStaticFilesLoader({prefix:a+"translations/locale-",suffix:".json"}).preferredLanguage("da").fallbackLanguage("da").forceAsyncReload(!0),e.when("/campaign",{controller:"CampaignOverviewController",templateUrl:a+"campaign-overview/campaign-overview.html?"+window.config.version}).when("/campaign/create",{controller:"CampaignController",templateUrl:a+"campaign/campaign.html?"+window.config.version}).when("/campaign/:id",{controller:"CampaignController",templateUrl:a+"campaign/campaign.html?"+window.config.version})}]),angular.module("campaignApp").service("campaignAppSetup",["busService","userService","$translate","$filter",function(e,n,a,i){"use strict";e.$on("menuApp.requestMainMenuItems",function(i,t){n.hasRole("ROLE_CAMPAIGN_ADMIN")&&e.$emit("menuApp.returnMainMenuItems",[{title:a.instant("menu.campaign"),route:"/#/campaign",activeFilter:"/campaign",icon:"picture_in_picture",weight:6}])}),e.$on("menuApp.requestHamburgerMenuItems",function(n,i){e.$emit("menuApp.returnHamburgerMenuItems",[{title:a.instant("menu.campaign"),weight:5,items:[{title:"Oversigt",route:"/#/campaign",activeFilter:"/campaign",weight:1},{title:"Opret kanal",route:"/#/campaign/create",activeFilter:"/campaign/create",weight:2}]}])}),e.$on("menuApp.requestSubMenuItems",function(i,t){var c=[];n.hasRole("ROLE_CAMPAIGN_ADMIN")&&c.push({title:a.instant("menu.campaign_create"),path:"#/campaign/create",activeFilter:"/campaign/create",group:"left",weight:1}),e.$emit("menuApp.returnSubMenuItems",[{mainMenuItem:"campaign",items:c}])}),e.$on("itkHeader.list.element.requestItems",function(n,i){if("screen"===i.type){var t=i.entity.api_data;if(t&&t.active_campaigns&&t.active_campaigns.length>0){var c='<div class="campaign-info">  <div tooltips tooltip-template="'+("<p>"+a.instant("messages.active_campaign_exists")+"</p>")+'" tooltip-side="top">    <img class="campaign-info--icon" src="bundles/os2displayadmin/images/icons/exclamation-icon.png" title="">  </div></div>';e.$emit(i.returnEvent,{html:c,type:"warning"})}}}),e.$on("itkHeader.entity.requestItems",function(n,t){if("screen"===t.type){var c=t.entity.api_data;if(c&&c.active_campaigns&&c.active_campaigns.length>0){var r='<div class="message campaign-info--message">  <div class="message--inner is-info">    <div class="message--content">'+c.active_campaigns.reduce(function(e,n){return e+"<p>"+a.instant("messages.active_campaign")+i("date")(n.schedule_from,"d/M/yyyy H:mm")+" - "+i("date")(n.schedule_to,"d/M/yyyy H:mm")+' (<a href="/#/campaign/'+n.id+'">'+n.title+"</a>)</p>"},"")+"    </div>  </div></div>";e.$emit(t.returnEvent,{html:r,type:"warning"})}}})}]),angular.module("campaignApp").run(["campaignAppSetup",angular.noop]),angular.module("campaignApp").controller("CampaignModalBase",["busService","$scope","$timeout","close",function(e,n,a,i){"use strict";n.closeModal=function(){i(null)}}]),angular.module("campaignApp").controller("CampaignOverviewController",["busService","$scope","$timeout","ModalService","$routeParams","$location","$controller","$filter","$q",function(e,n,a,i,t,c,r,o,s){"use strict";n.loading=!0,n.selectedCampaigns={},n.sortOrder=!0,n.search={title:""},n.allCheckbox=!1,r("BaseApiController",{$scope:n});var l=o("translate");if(!n.requireRole("ROLE_CAMPAIGN_ADMIN"))return e.$emit("log.error",{timeout:5e3,cause:403,msg:l("common.error.forbidden")}),void c.path("/");function u(){n.loading=!0,n.getEntities("campaign").then(function(e){n.campaigns=Object.keys(e).map(function(n){return e[n]});var a=parseInt(new Date/1e3);for(var i in n.campaigns)if(n.campaigns.hasOwnProperty(i)){var t=n.campaigns[i],c=parseInt(new Date(t.schedule_from)/1e3),r=parseInt(new Date(t.schedule_to)/1e3);t.status=c<=a&&r>a?"active":r<a?"expired":"future"}},function(n){e.$emit("log.error",{cause:n.code,msg:l("common.error.could_not_load_results")})}).then(function(){n.loading=!1})}u(),n.help=function(){e.$emit("bodyService.addClass","is-locked"),i.showModal({templateUrl:"bundles/os2displaycampaign/apps/campaignApp/campaign-overview/modalHelp.html",controller:"CampaignModalBase"}).then(function(n){n.close.then(function(){e.$emit("bodyService.removeClass","is-locked")})})},n.deleteCampaigns=function(){if(n.showDelete()){var a=[],t=angular.element(".js-campaign-checkbox");angular.forEach(t,function(e){var i=e.id,t=e.checked;if(-1!==i.indexOf("campaign-")&&(i=parseInt(i.split("campaign-")[1]),t)){var c=n.campaigns.find(function(e){return e.id===i});c&&a.push(c)}}),i.showModal({templateUrl:"bundles/os2displaycampaign/apps/campaignApp/campaign-overview/campaignOverviewModalDelete.html",controller:"CampaignOverviewModalDelete",inputs:{campaigns:a}}).then(function(i){i.close.then(function(i){if(!0===i){var t=[];for(var c in a)a.hasOwnProperty(c)&&t.push(n.deleteEntity("campaign",a[c]));s.all(t).then(function(){u(),e.$emit("log.info",{cause:200,timeout:3e3,msg:l("messages.campaign_delete_success")})},function(n){e.$emit("log.error",{cause:n.code,msg:l("messages.campaign_delete_error")})})}e.$emit("bodyService.removeClass","is-locked")})})}},n.flipSortOrder=function(){n.sortOrder=!n.sortOrder},n.showDelete=function(){return Object.values(n.selectedCampaigns).reduce(function(e,n){return e+(n?1:0)},0)},n.clickAllCheckbox=function(e){var a=angular.element(".js-campaign-checkbox"),i=[];angular.forEach(a,function(e){var a=e.id,t=e.checked;if(-1!==a.indexOf("campaign-")&&(a=parseInt(a.split("campaign-")[1]),t)){var c=n.campaigns.find(function(e){return e.id===a});c&&i.push(c)}}),i.length===n.campaigns.length?(angular.forEach(a,function(e){e.checked=!1}),n.selectedCampaigns=n.campaigns.reduce(function(e,n){return e[n.id]=!1,e},{}),n.allCheckbox=!1):(angular.forEach(a,function(e){e.checked=!0}),n.selectedCampaigns=n.campaigns.reduce(function(e,n){return e[n.id]=!0,e},{}),n.allCheckbox=!0)},n.clickCheckbox=function(){n.allCheckbox=Object.values(n.selectedCampaigns).reduce(function(e,n){return e+(n?1:0)},0)===n.campaigns.length}}]),angular.module("campaignApp").controller("CampaignOverviewModalDelete",["busService","$scope","$timeout","close","campaigns",function(e,n,a,i,t){"use strict";n.campaigns=t,n.confirm=function(){i(!0)},n.closeModal=function(){i(null)}}]),angular.module("campaignApp").controller("CampaignController",["busService","$scope","$timeout","ModalService","$routeParams","$location","$controller","$filter",function(e,n,a,i,t,c,r,o){"use strict";n.loading=!0,r("BaseApiController",{$scope:n});var s=o("translate");if(!n.requireRole("ROLE_CAMPAIGN_ADMIN"))return e.$emit("log.error",{timeout:5e3,cause:403,msg:s("common.error.forbidden")}),void c.path("/");var l=t.id;if(n.campaign=null,l)n.getEntity("campaign",{id:l}).then(function(e){var a;n.campaign=((a=e).schedule_from=parseInt(new Date(a.schedule_from)/1e3),a.schedule_to=parseInt(new Date(a.schedule_to)/1e3),a)},function(n){c.path("/#/campaign"),e.$emit("log.error",{cause:n.code,msg:s("messages.campaign_load_error")})}).then(function(){n.loading=!1});else{var u=new Date;u.setMilliseconds(0),u.setSeconds(0),u.setMinutes(0),u=parseInt(u/1e3),n.campaign={title:"",description:"",schedule_from:u,schedule_to:u+86400,channels:[],screens:[],screen_groups:[],groups:[]},n.loading=!1}n.addChannels=function(){n.campaign.channels||(n.campaign.channels=[]),e.$emit("bodyService.addClass","is-locked"),i.showModal({templateUrl:"bundles/os2displaycampaign/apps/campaignApp/campaign/campaignModalAddChannel.html",controller:"CampaignModalAddChannel",inputs:{channels:n.campaign.channels}}).then(function(n){n.close.then(function(){e.$emit("bodyService.removeClass","is-locked")})})},n.removeChannel=function(e){-1!==n.campaign.channels.indexOf(e)&&n.campaign.channels.splice(e,1)},n.addScreens=function(){n.campaign.screens||(n.campaign.screens=[]),e.$emit("bodyService.addClass","is-locked"),i.showModal({templateUrl:"bundles/os2displaycampaign/apps/campaignApp/campaign/campaignModalAddScreen.html",controller:"CampaignModalAddScreen",inputs:{screens:n.campaign.screens}}).then(function(n){n.close.then(function(){e.$emit("bodyService.removeClass","is-locked")})})},n.removeScreen=function(e){-1!==n.campaign.screens.indexOf(e)&&n.campaign.screens.splice(e,1)},n.addScreenGroups=function(){n.campaign.screen_groups||(n.campaign.screen_groups=[]),e.$emit("bodyService.addClass","is-locked"),i.showModal({templateUrl:"bundles/os2displaycampaign/apps/campaignApp/campaign/campaignModalAddScreenGroup.html",controller:"CampaignModalAddScreenGroup",inputs:{screenGroups:n.campaign.screen_groups}}).then(function(n){n.close.then(function(){e.$emit("bodyService.removeClass","is-locked")})})},n.removeScreenGroup=function(e){-1!==n.campaign.screen_groups.indexOf(e)&&n.campaign.screen_groups.splice(e,1)},n.save=function(){if(n.campaign.title){n.loading=!0;var a,i=angular.copy(n.campaign);(a=i).schedule_from=new Date(1e3*a.schedule_from).toISOString(),a.schedule_to=new Date(1e3*a.schedule_to).toISOString(),i=a,void 0===n.campaign.id?n.createEntity("campaign",i).then(function(){e.$emit("log.info",{cause:200,timeout:3e3,msg:s("messages.campaign_created")}),c.path("/campaign")},function(n){var a=s("messages.campaign_created_error");409===n.code&&(a=s("messages.campaign_created_error_duplicate")),e.$emit("log.error",{cause:n.code,msg:a})}).then(function(){n.loading=!1,window.scrollTo(0,0)}):n.updateEntity("campaign",i).then(function(){e.$emit("log.info",{cause:200,timeout:3e3,msg:s("messages.campaign_updated")}),c.path("/campaign")},function(n){var a=s("messages.campaign_updated_error");409===n.code&&(a=s("messages.campaign_updated_error_duplicate")),e.$emit("log.error",{cause:n.code,msg:a})}).then(function(){n.loading=!1,window.scrollTo(0,0)})}else e.$emit("log.error",{cause:400,msg:s("messages.campaign_created_error_no_title")})}}]),angular.module("campaignApp").controller("CampaignModalAddChannel",["busService","$scope","$timeout","close","channels",function(e,n,a,i,t){"use strict";n.channels=t,n.$on("channelOverview.clickChannel",function(e,i){var t;t=i,a(function(){var e=null;n.channels.forEach(function(n,a){t.id===n.id&&(e=a)}),null!==e?n.channels.splice(e,1):n.channels.push(t)})}),n.closeModal=function(){i(null)}}]),angular.module("campaignApp").controller("CampaignModalAddScreen",["busService","$scope","$timeout","close","screens",function(e,n,a,i,t){"use strict";n.screens=t,n.$on("itkScreenList.clickScreen",function(e,i){var t;t=i,a(function(){var e=null;n.screens.forEach(function(n,a){t.id===n.id&&(e=a)}),null!==e?n.screens.splice(e,1):n.screens.push(t)})}),n.closeModal=function(){i(null)}}]),angular.module("campaignApp").controller("CampaignModalAddScreenGroup",["busService","$scope","$timeout","close","screenGroups","userService",function(e,n,a,i,t,c){"use strict";n.availableGroups=c.getCurrentUser().groups,n.screenGroups=t,n.groupSelected=function(e){if(!n.screenGroups)return!1;var a=!1;return n.screenGroups.forEach(function(n){n.id===e.id&&(a=!0)}),a},n.clickGroup=function(e){var i;i=e,a(function(){var e=null;n.screenGroups.forEach(function(n,a){i.id===n.id&&(e=a)}),null!==e?n.screenGroups.splice(e,1):n.screenGroups.push(i)})},n.closeModal=function(){i(null)}}]),angular.module("campaignApp").directive("contenteditable",function(){return{restrict:"A",require:"ngModel",link:function(e,n,a,i){function t(){i.$setViewValue(n.html())}i.$render=function(){n.html(i.$viewValue||"")},n.bind("blur keyup change",function(){e.$apply(t)})}}}),angular.module("campaignApp").directive("campaignScreenList",["busService","$translate",function(e,n){"use strict";return{restrict:"E",scope:{selectedScreens:"=",overlay:"@"},controller:["$scope","$filter","$controller","screenFactory","userService","busService",function(e,a,i,t,c,r){i("BaseSearchController",{$scope:e}),e.showFromUser=localStorage.getItem("overview.media.search_filter_default")?localStorage.getItem("overview.media.search_filter_default"):"all",e.screens=[];var o=null;e.updateSearch=function(){e.baseQuery.text=e.search_text,e.loading=!0,t.searchScreens(e.baseQuery).then(function(a){e.hits=a.hits;for(var i=[],c=0;c<a.results.length;c++)i.push(a.results[c].id);o&&i.length===o.length&&i.every(function(e,n){return e===o[n]})?e.loading=!1:(o=i,t.loadScreensBulk(i).then(function(n){e.screens=n,e.loading=!1},function(a){r.$emit("log.error",{cause:a,msg:n("common.error.could_not_load_results")}),e.loading=!1}))})},e.screenSelected=function(n){if(!e.selectedScreens)return!1;var a=!1;return e.selectedScreens.forEach(function(e){e.id===n.id&&(a=!0)}),a},e.clickScreen=function(n){e.$emit("itkScreenList.clickScreen",n)},e.$on("screen-deleted",function(){e.updateSearch()}),e.setSearchFilters=function(){delete e.baseQuery.filter;var n=a("filter")(e.userGroups,{selected:!0},!0).map(function(e){return e.id});e.baseQuery.filter=e.baseBuildSearchFilter(n),e.pager.page=0,e.updateSearch()},e.setSearchFilters()}],templateUrl:"bundles/os2displaycampaign/apps/campaignApp/directives/screenList/campaignScreenList.html?"+window.config.version}}]);